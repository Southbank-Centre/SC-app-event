"use strict";angular.module("SC-app-event",["angular.filter","angularMoment"]),angular.module("SC-app-event").controller("EventListCtrl",["$rootScope","$scope","$stateParams","$location","eventFactory","utilitiesFactory","$filter","$window",function(a,b,c,d,e,f,g,h){e.getEventList(function(a){b.loadNextEvents=function(){var a=b.events.length;b.events.push.apply(b.events,b.allEvents.list.slice(a,a+c))},b.resetEvents=function(){b.events=b.filtersApplied()?b.allEvents.list:b.allEvents.list.slice(0,c)};var c=10;b.allEvents=a,b.resetEvents()},f.genericHTTPCallbackError),b.filterFieldMapping={eventTypeSlug:{name:"type"},field_start_day:{name:"day",momentFormat:"dddd-D-MMMM-YYYY"},ticketTypes:{name:"ticket"}},b.search={},angular.forEach(d.search(),function(a,c){angular.forEach(b.filterFieldMapping,function(d,e){d.name===c&&(d.momentFormat&&(a=h.moment(a,d.momentFormat).format("dddd D MMMM YYYY")),b.search[e]=a)})}),b.$watchCollection("search",function(a){angular.forEach(a,function(a,c){null===a?delete b.search[c]:(b.filterFieldMapping[c].momentFormat&&a&&(a=h.moment(a).format(b.filterFieldMapping[c].momentFormat)),"string"==typeof a&&(a=a.toLowerCase())),d.search(b.filterFieldMapping[c].name,a)});var c=d.url();h.dataLayer.push({event:"pageview",virtualUrl:c})}),b.strictOrAll=function(a,b){return"object"==typeof a&&null!==b&&a.hasOwnProperty("_isAMomentObject")&&a._isAMomentObject&&(a=a.format("YYYYMMDDhhmmss")),"object"==typeof b&&null!==b&&b.hasOwnProperty("_isAMomentObject")&&b._isAMomentObject&&(b=b.format("YYYYMMDDhhmmss")),null===b?!0:"string"!=typeof a&&"number"!=typeof a?!1:("number"==typeof a&&(a=a.toString()),null!==a.match(new RegExp(b,"i")))},b.showAllDays=function(){return""===angular.element("#event-day-filter").val()?!0:void 0},b.filtersApplied=function(){var a=!1;return angular.forEach(b.search,function(b){return b?(a=!0,!1):void 0}),a}}]),angular.module("SC-app-event").controller("EventSingleCtrl",["$rootScope","$scope","$stateParams","$state","eventFactory","utilitiesFactory",function(a,b,c,d,e,f){e.getEventSingle(c.eventAlias,function(c){b.event=c,a.websiteTitleDefault=a.websiteTitle,a.websiteTitle=b.event.title,a.websiteDescriptionDefault=a.websiteDescription,a.websiteDescription=b.event.field_teaser.value.replace(/(<([^>]+)>)/gi,"")},f.genericHTTPCallbackError),a.$on("$stateChangeStart",function(){a.websiteTitle=a.websiteTitleDefault,a.websiteDescription=a.websiteDescriptionDefault})}]),angular.module("SC-app-event").filter("formatTicketHelpText",function(){return function(a){return a.field_help_text.replace(/\[TICKET NAME\]/g,a.name)}}),angular.module("SC-app-event").factory("eventFactory",["$http","$rootScope","$filter","$window","utilitiesFactory","angularMomentConfig","appConfig",function(a,b,c,d,e,f,g){return{getEventSingle:function(b,c,d){a.get("/json/api/performance/"+b).success(function(a){a.field_start_time&&(a.field_start_time=e.timestampSecondsToMS(a.field_start_time)),a.field_end_time&&(a.field_end_time=e.timestampSecondsToMS(a.field_end_time)),a.field_end_time&&a.field_start_time&&(a.duration=a.field_end_time/6e4-a.field_start_time/6e4),c(a)}).error(d)},getEventList:function(h,i){function j(a){var b=[];angular.forEach(a.list,function(a,g){if(a.field_production){if(a.field_start_time=d.moment(e.timestampSecondsToMS(a.field_start_time)).tz(f.timezone),a.field_end_time=d.moment(e.timestampSecondsToMS(a.field_end_time)).tz(f.timezone),a.field_start_time){var h=a.field_start_time;a.field_start_day=d.moment(h).tz(f.timezone).startOf("day").format("dddd D MMMM YYYY");var i=d.moment(h).tz(f.timezone).startOf("hour");a.field_start_hour=i;var j=a.field_production.field_event_type.name;a.eventType=j,a.eventTypeSlug=c("slugify")(j),null!==a.field_wristband_ticket&&(a.ticketTypes=[],angular.forEach(a.field_wristband_ticket,function(b){a.ticketTypes.push(c("slugify")(b.name))}))}}else b.push(g)}),b.reverse(),angular.forEach(b,function(b){a.list.splice(b,1)}),h(a)}var k="/json/node.json?type=performance&sort=field_start_time&direction=ASC";g.festivalId&&(k=k+"&field_festival="+g.festivalId),a.get(k).success(function(a){b.ticketingDataLoaded?j(a):b.$on("event:ticketingDataLoaded",function(){j(a)})}).error(i)},getEventCount:function(b,c){var d="/json/node.count?type=performance";g.festivalId&&(d=d+"&field_festival="+g.festivalId),a.get(d).success(function(a){b(a.count)}).error(c)}}}]);